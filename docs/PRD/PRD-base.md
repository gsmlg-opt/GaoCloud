# 1      文档介绍

## 1.1         文档的目的

此文档是提供用于软件开发部门和产品设计部门、产品测试部门之间就此产品的需求分析、产品开发、产品设计、测试方案交流的基础；

## 1.2         参考文档

| **序号** | **文档名称** | **作者** | **来源**                                                     |
| -------- | ------------ | -------- | ------------------------------------------------------------ |
| 1        | 产品原型     | 王少帅   | https://lanhuapp.com/web/#/item/project/product?pid=ae53d49b-3634-4b45-86c5-602306d459b9&docId=39f5c399-104a-4781-983a-0f34a7e0d50f&docType=axure&pageId=574cfae64117412e9cde02e86880c747&image_id=39f5c399-104a-4781-983a-0f34a7e0d50f&parentId=6190da3959c241c5ba311eea7a3bd897 |
| 2        | 产品设计     | 关倩     | https://lanhuapp.com/web/#/item/project/board?pid=ae53d49b-3634-4b45-86c5-602306d459b9&docId=99c0f495-78d3-44c2-8edc-fd54fc41ea91&docType=axure&pageId=574cfae64117412e9cde02e86880c747&image_id=99c0f495-78d3-44c2-8edc-fd54fc41ea91&parentId=6190da3959c241c5ba311eea7a3bd897 |

 

 

## 1.3         产品命名规范

| **产品名称Zcloud** |          |      |
| ------------------ | -------- | ---- |
| 中文名称           | 英文名称 | 备注 |
|                    |          |      |
|                    |          |      |

# 2      基础运维功能

1、  集群列表

2、  用户

3、  资源审批

4、  集群管理

5、  镜像仓库

6、  集群监控

# 3      产品功能结构图

* 全局
  * 集群列表
  * 全局配置
* 集群管理
  * 概况
  * 命名空间
  * 节点
  * 存储
  * 网络
* 资源申请
  
  * 申请列表
* 用户管理
  
  * 用户创建、删除、编辑
* 系统工具
  * 镜像仓库（跳转）
  * 监控中心（跳转）
  * 日志分析（跳转）

# 4      功能需求

## 4.1         导航栏

### **4.1.1**    功能原型

*参见1.2* *参考文档*

### **4.1.2**    功能概述

对全局性的功能进行操作，包含菜单导航收缩、菜单导航、集群选择、命名空间选择、集群命令行、通知、帮助、用户功能列表。

### **4.1.3**    功能(业务)流程图

无

### **4.1.4**    功能点清单

* 导航栏
  * 导航收缩
  * 菜单导航
    * 全局、集群管理、容器管理、应用商店、应用管理、基础资源、资源申请、镜像仓库、监控中心
  * 集群选择
  * 命保空间选择
  * 集群命令行
  * 通知
  * 帮助
  * 用户功能列表 

### **4.1.5**    功能详细描述

导航栏收缩：控制导航栏收起或展开，收起时只留图标，展示开显示图标加文字。

菜单导航：这里只包含两种逻辑，没有选择集群和已选择集群。当没有选择集群时，只显示总览与资源申请。当选择集群后，要显示所有菜单。

集群选择：下拉菜单，列出该用户权限内的所有集群。

命名空间选择：下拉菜单，列出该用户权限内的所有命名空间。

集群命令行：只有选择集群后，此按钮才可用。为了方便用户在任何操作页面可以随时进入集群命令行设计。

通知：zcloud产生的通知，为集群产行的告警等消息。

帮助：zcloud使用帮助手册。

用户功能：用户编辑、用户详情、修改密码、用户列表、注销。

### **4.1.6**    业务数据描述

1、角色信息（角色名称、角色描述）

角色名称：20个英文字符

角色描述：50个中文字符

角色权限：复选框选择

 

2、用户信息（用户名、备注、集群权限）

​        用户名： 由字母a～z(不区分大小写)、数字0～9、点、减号或下划线组成。只能以数字或字母开头和结尾 用户名长度为4～20个字符。

​        登陆密码：6到16个字符。机器生成

 

## 4.2         全局

### **4.2.1**    原型

*参见原型地址。*

### **4.2.2**    功能概述

展示所有已被zcloud纳管的集群列表。

### **4.2.3**    功能点清单

* 集群一级操作

  - 展示集群
  - 创建集群
  - 删除集群

* 集群二级操作

  - 集群命令行

  - 取消操作

  - 安装日志

  - 添加节点

  - 删除节点 


* 全局配置
* 操作日志


### **4.2.4**    功能详细描述

#### **4.2.4.1**      集群列表

**功能点描述：** 对zcloud已纳管的集群做概要的信息展示。

具体展示字段，集群状态、集群名称、节点数、CPU使用与总量、内存使用与总量（单位放在表头）、容器数使用与总容量、kubernetes版本、操作（命令行、重新部署、删除、查看安装日志、编辑）

可通过集群名称进行搜索过滤。

集群整个生命周期内，所有状态的转换关系图。

```
+---------------------------------------------------------------------------+
|                                                                           |
|                                                                           |
|                                                                           v
|             +---------+                                            +------+------+
|             |         |      loadDB                   delete       |             |
|             |  Init   +-------------------+     +----------------->+   Deleting  +----+
|             |         |                   |     |                  |             |    |
|             +-----+---+                   |     |                  +------+------+    |
|                   |                       |     |                         ^           |
|                   +                       |     |                         +           |
|                create                     |     |                      delete         |
| delete            +                       |     |                         +           |
|                   v                       v     |                         |           |
|             +-----+-----+             +---+-----+---+getInfoFailed +------+------+    |
|             |           |createSucceed|             +------------->+             |    |
|             |  Creating +------------>+  Running    |              | Unreachable |    |
|             |           |             |             +<-------------+             |    |deleteCompleted
|             +-+-------+-+             +--+------+---+getInfoSucceed+-------------+    |
|               |       ^                  |      ^                                     |
|   creatFailed |       |                  |      |                                     |
|   createCanceled      +              update     |updateCompleted                      |
|               |  continuteCreate         |      |updateCanceled                       |
|               |       |                  |      |                                     |
|               v       |                  v      |                                     |
|             +-+-------+--+            +--+------+---+              +-------------+    |
|             |            |            |             |              |             |    |
+-------------+CreateFailed|            |   Updating  |              |   Deleted   +<---+
              |            |            |             |              |             |
              +------------+            +-------------+              +-------------+
```

#### **4.2.4.2**      创建集群

**功能点描述：** 进行集群的创建。

创建参数如下：

集群属性设置：集群名称，集群域名后缀。

Zke设置：zcloud服务IP，zcloud服务端口。

SSH设置：用户名，ssh私钥文件，ssh连接端口。

集群网络设置：服务IP段，POD IP段，flannel或是calico，集群内部DNS IP，转发DNS IP。

私有仓库设置：URL，CA证书，用户名，密码。

添加节点设置：主机名，IP，角色（master和etcd与其它角色互斥）

**描述**

创建集群时，集群状态初始为creating，若创建成功（zcloud可正常访问api server），则集群状态变为running。只有running状态下，才可以选择集群，进行其它操作。若失败，集群状态为CreateFailed。

#### **4.2.4.3**      删除集群

**功能点描述：** 对集群进行删除操作。

删除zcloud的集群记录，zcloud记录的集群资源要关联删除。

集群删除：在unreachable，running，CreateFailed状态下可以操作删除集群。

#### **4.2.4.4**      集群操作

**功能点描述：** 对集群进行管理操作。

在集群管理功能中，用户可以对集群的状态进行管理，在创建中、更新中可以进行终止操作。并且可以查看集群的属性字段。可以对集群的节点进行添加或删除的操作。

各种状态下，可进行的操作如下：

Creating：命令行不可使用、停止与日志可用

CreateFailed：命令行、停止不可使用，日志可用

Running：命令行-可使用，停止与日志不可使用

Updating：命令行不可使用、停止与日志可用

Unreachable：命令行、停止与日志不可使用

Deleting：命令行、停止与日志不可使用

#### **4.2.4.5**      删除节点

**功能点描述：**  删除集群节点。

删除节点：支持批量删除

**描述**

删除节点实际上是对集群的update操作，当节点变动时，集群状态会有两种结果running - updating - running成功，这时查看节点数会相应的减少。running - updating -running 失败，集群节点无变化。在etcd良好运行的情况下，删除操作不会失败。

running与CreateFailed状态的集群才允许做删除节点。

若集群只剩余一个master节点，则不允许删除master节点；

若集群只剩余一个etcd节点，则不允许删除etcd节点；

若集群只剩余一个worker节点，则不允许删除workder节点；

master节点与etcd节点，只允许增加，不允许删除。后续版本再考虑master与etcd节点的删除操作。

#### **4.2.4.6**      添加节点

**功能点描述：** 添加集群节点。

添加节点设置：主机名，IP，角色（master和etcd与其它角色互斥）

**描述**

添加节点实际上是对集群的update操作，当节点变动时，集群状态会有两种结果running - updating - running成功，这时查看节点数会相应的减少。running - updating -running 失败，如果发生失败，添加的节点信息保存在集群配置里。并且节点数量不会变。

#### **4.2.4.7**      进入集群命令行

**功能点描述：** 进入集群的命令行，进行信息的查看操作。

**描述**

只有running状态下的集群才可用，进入命令行后，用户只有只读权限。

#### **4.2.4.8**      终止操作

**功能点描述：** 对集群的创建或更新动作进行取消。

**描述**

creating，updating状态可进行取消操作。

#### **4.2.4.9**      查看创建或更新日志

**功能点描述：** 查看创建或更新日志

**描述**

仅creating和updating状态可查看创建/更新日志。

当创建或更新成功后：日志功能不可用。

当创建或更新失败后：日志功能可用，且可查看日志。

每次创建或更新中时，只展示本次日志，并且二次打开日志，本次操作的所有日志都需要展示。

#### **4.2.4.7**      全局配置

**功能点描述：** 配置监控指标

**描述**

集群指标：CPU、内存、存储、POD数， CPU、内存、存储三个指标分别对应三个纬度，1、集群（含POD）；2、namespaces；3、节点（不含存储）；4、应用（只有存储）

收邮件地址、发邮件地址与密码、SMTP协议地址，SMTP端口号。

#### **4.2.4.8**      操作日志

**功能点描述：** 记录用户的创建、修改、删除操作

**描述**：操作日志，只记录谁在什么时间干了啥，参数验证不通过的不记录。

创建操作有：创建集群、创建存储、创建应用、创建弹性伸缩、创建无状态副本/有状态副本/守护进程/定时任务/任务、创建服务、创建路由、创建配置字典、创建保密字典、创建资源申请

修改的操作有：修改集群（含添加节点），修改存储，修改弹性伸缩，修改无状态副本/有状态副本/守护进程/定时任务/任务、修改服务、修改路由、修改配置字典、修改保密字典

删除操作有：删除集群、删除存储、删除应用、删除弹性伸缩、删除无状态副本/有状态副本/守护进程/定时任务/任务、删除服务、删除路由、删除配置字典、删除保密字典

操作日志记录上传的参数json内容，放入操作日志详情里即可，不需要记录操作结果。

#### **4.2.4.11** 集群修改

只有处于失败状态的集群才允许修改。可修改的字段属性如下：

ssh用户名、ssh端口、ssh私钥

### **4.2.5**    业务数据描述

1、新建集群信息

集群名称：20位中文字符或英文字符

## 4.3         集群管理

### **4.3.1**    功能原型

*参见原型地址。*

### **4.3.2**    功能概述

对集群的资源使用和基本信息进行展示，维护集群的节点资源与命名空间资源。

### **4.3.3**    功能点清单

* 概览
  * 展示集群创建信息、资源使用
* 命名空间
  * 展示列表、命名空间详情、新建、删除，命名空间的编辑指的是编辑资源配额
* 节点
  * 节点列表、名称，状态，容器版本，CPU，MEM，POD，节点详情，节点的增加与删除在集群编辑页面
* 存储
  * 集群的存储管理，本地存储，网络存储，增加删除更改。
* 网络
  * 展示网络信息与IP使用情况

 

### **4.3.4**    功能详细描述

#### **4.3.4.1**      概览

集群信息：展示集群名称、k8s版本号、部署本集群的zcloud版本号，节点数、创建时间。

资源信息： CPU使用情况、MEM使用情况、Pods使用情况。

#### **4.3.4.2**      命名空间

命名空间需要有创建功能、删除功能与编辑功能。

创建：创建命名空间时，需要输入资源配额一起进行创建。

删除：删除命名空间时，所属资源全部清空。

编辑：编辑命名空间时，只允许编辑资源配额的数值。命名空间名称不可以修改。

#### **4.3.4.3**      节点

展示本集群内，所有节点的列表。并且列表页显示节点名称，节点的状态，IP地址，角色，标签，创建时间。在此页面，不允许增加、删除、编辑。

详情页面显示属性如下：

节点名称、IP地址、角色、Docker版本、操作系统、内核版本、创建时间、cpu、mem、pods。

**操作**

cordon：停止调度
uncordon：恢复

drain：驱逐所有POD

集群内worker节点需要支持以上三种操作，master和存储节点不支持。用来排查问题，或对节点进行维护。节点维护CPU、MEM时使用。操作逻辑如下：

cordon后，可以使用uncordon或drain，drain后只能使用uncordon。正常情况下，只有cordon、drain可使用。

#### **4.3.4.4**      存储

存储列表页需要显示存储名称，存储状态，类型，包含的节点，总大小，已分配，未分配。

存储支持两种类型：本地存储（lvm），网络存储（ceph）。创建的存储列表只能创建两条。

**创建**

Storageclass名称与存储集群名称一致。用户选择当前集群可用的带有存储的节点加入到存储集中。对于可用的定义如下：节点有块设备，块设备没有文件系统，块设备没有被zcloud存储使用，块设备为空设备，满足以上所有条件，该节点才是可用的。

目前需要支持本地存储（lvm），网络存储（ceph），创建时指定类型。

**删除**

删除存储的storageclass时，需要检测是否有POD正在使用，若有POD正在使用，设置垃圾回收，并对用户做友好性提示。

**查看**

本地存储（lvm）：在详情页中，展示所有节点与pvc，当单击某一个节点的时候，只显示当前节点的pvc。管理员能看到存储使用情况的统计数据。

网络存储（ceph）：在详情页中，展示所有节点与pvc，不支持按节点对pvc进行过滤。管理员能看到存储使用情况的统计数据。

**编辑**

编辑存储时，可以删除也可以增加。删除节点如果是ceph，时间会比较长。需要展示存储集的相应状态。

**状态**

对于存储资源，状态变动的有两种情况：创建、更新。某一个块设备异常只有事件，存储的状态不应该受影响。存储在创建时状态变化比较多，用文字显示。更新时存储集群显示更新即可，具体每一个块设备的状态待后续开发。

**PVC扩容**

当为workload创建pvc之后，pvc支持容量的扩容操作。存储类型不可变更，pvc扩容只允许在可用的存储空间内自定义大小。只允许增加，不允许减少。

**新增ISCIS，NFS存储**

1、不同类型存储节点互斥，LVM、CEPH、ISCIS，后台过滤  
2、ISCIS在同一节点可以创建多个   
3、用户选择NFS是，大小不可以指定（workload页面，选择NFS是，大小输入框隐藏）  
4、NFS展示时，没有节点信息，只有pv信息  
5、NFS存储只能新增或删除，不可编辑  
6、ISCIS存储的连接信息不能修改，只允许增删节点   

**存储规则**

所有存储都不能使用master节点

cephfs和lvm之间有节点互斥，iscsi和nfs  没有节点互斥。
iscsi存储删除后，数据不做处理，下次如果要继续使用就必须使用与之前一样的存储名称。

iscsi和nfs每个类型可以创建多个，lvm和cephfs每个类型只能创建一个。

块存储：lvm和iscsi是ReadWriteOnce
文件存储：cephfs和nfs是ReadWriteMany

#### **4.3.4.5**      网络

展示集群的网络信息，类型、地址段等。并且展示集群每个node的IP使用情况。

POD IP：分为列表页与详情页两层。

列表页按节点划分元素。显示节点名称、POD网段、地址总数、已使用地址数、未使用地址数。别且支持展示详细的使用情况。某一个IP被哪个POD使用了。

如果POD使用的是主机的IP，需要在每一个元素展开式，进行单独的展示。POD名称，POD端口。

服务IP：展示此集群创建的所有服务。显示服务名称与IP即可。

### **4.3.5**    业务数据描述

命名空间名称：自定义名称-前6位sha256(username)

## 4.4         资源申请

### **4.4.1**    功能概述

在平台中，资源申请为一种资源对像。此对像没有父资源，相关联的k8s资源为命名空间。开发用户只能通过此项功能进行资源的申请。用户申请的资源需要经过基础运维人员审核通过后才可使用。

### **4.4.2**    功能点清单

* 资源申请查询
* 资源申请祥情
* 资源申请删除
* 资源申请审批 

### **4.4.3**    功能详细描述

#### 4.4.3.1      资源申请查询

**功能点描述：** 普通用户：展示该用户所有的申请记录，管理员：展示平台内所有的申请列表。

已批复的资源申请，如需调整，需要在原有记录再次调整。处于驳回或审核中的记录不允许删除、调整。

#### 4.4.3.2      资源申请详情

**功能点描述：** 普通用户使用该功能时，看到的是申请的所有信息详情页，包含拒绝原因等内容。

#### 4.4.3.3      资源申请删除

**功能点描述：** 删除资源申请记录、此动作同时会清理用户已申请的命名空间。

正在审核的申请不允许删除，驳回、审核通过的记录才可以删除。删除申请记录时，会联动删除该命名空间。

#### 4.4.3.4      资源申请审批、驳回

**功能点描述：** 管理员对用户的资源申请进行审核，审核通过后，平台需要联动创建相应的命名空间与ResourceQuota。若是驳回请求，则后台资源不做任何变动。若驳回的是调整的申请，则申请记录状态变成已驳回。

### **4.4.4**    业务数据描述

## 4.5  用户管理

### **4.5.1**    功能概述

平台用户的管理，可以创建、删除、编辑。对用户的权限进行管理。 

### **4.5.2**    功能点清单

* 用户创建
* 用户删除
* 用户编辑
* 密码修改 

### **4.5.3**    功能详细描述

#### **4.5.3.1**      用户创建

**功能点描述：** 创建平台普通用户，并设置密码与用户权限。

#### **4.5.3.2**      用户删除

**功能点描述：** 删除平台用户，用户相关资源不做处理。

#### **4.5.3.3**      用户编辑

**功能点描述：** 此功能只能修改用户所以集群权限，其它属情字段待进一步总结需求后再给出。

#### **4.5.3.3**      密码修改

 **功能点描述：** 管理员使用此功能只能直接重置用户的密码，普通用户使用此功能只能做修改密码操作。

### **4.5.4**    业务数据描述

 系统管理

## 4.6 Zcloud事件

### 4.6.1    功能概述

记录Zcloud平台发生的事件，事件分类如下：操作预警、资源预警。

事件只有已读和未读，最新的1000条预警内容，包含已读和未读。当月满足1000条时，滚动删除。

告警策略：资源类的60s检测一次，超过就告警。

### **4.6.2**    功能点清单 

1、k8s事件

2、Zcloud事件

3、资源预警

### **4.6.3**    功能详细描述

#### **4.6.3.1**      k8s事件

k8s发生应用事件，仅展示权限内的，不包含集群的事件。产生事件的资源有，节点，storageclass，ns，workload，pod，pvc，存储告警。当这事件对象中有警告或错误时，事件才记录入铃铛。

权限没有实现，往后放。

#### **4.6.3.2**      zcloud事件

k8s失败，这个是异步发生的。所以我们只需要记录异步失败事件并注明原因。通过铃铛页面进行展示即可。立即返回的不在铃铛中记录。

#### 4.6.3.3 预警

1、阈值设置

在基础运维平台，支持以下指标的定义与预警。

cluster：CPU、MEM、POD、存储（所有class使用同一个指标预警）

node：CPU、MEM

namespaces：CPU、MEM、存储

POD：存储

用户空间指标：用户空间所有POD使用CPU、MEM、存储的量占用户申请资源的百分比。若用户空间没有申请资源，则按集群总量资源量计算。

应用指标：用户权限内的POD使用的pvc存储量，占POD申请PVC总大小的百分比。

预警方式：目前只支持邮件。Zcloud提供预警查看功能。

2、通知

邮件通知与通过铃铛的页面进行展示。

### **4.6.4**    业务数据描述

## 4.7 系统工具

### 4.7.1    功能概述

系统管理员需要完成工具的初始化。

### **4.7.2**    功能点清单 

#### **4.7.2.1**      镜像仓库

需要输入访问域名，存储大小，用户名默认admin，密码默认zcloud。

#### **4.7.2.2**      监控中心

直接安装即可，用户名默认admin，密码默认zcloud。

#### **4.7.2.3**      日志分析

需要输入访问域名，存储大小。存储大小用户的输入需要在后台做除以3处理。

## 4.8      负载均衡联动

### 4.8.1删除

Zcloud所有资源全部是异步删除，用户列表无状态（用户被删除，下面的资源不删除）。

除了特例外，需要增加状态的资源有：namespaces、node、存储、app资源、k8s资源、资源申请。资源表格增加删除时间列。

以上资源，除了删除中的状态，其他状态都可以删除。

删除中的状态，只能等待资源删除成功或删除失败。

删除成功的资源，在系统内要清理干净。

对于删除失败的资源，可以再次删除。删除失败当前页面资源下方使用红色小子提示，同时写入Zcloud平台事件。

### 4.8.2 负载联动

外部负载需求

K8s包含三种类型的服务：ClusterIP、[NodePort](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport)、[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)。

Ø **ClusterIP**：通过集群的内部 IP 暴露服务，服务只能够在集群内部可以访问。

Ø [**NodePort**](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport)**：**通过每个 Node 上的 IP 和静态端口暴露服务。NodePort 服务会NAT到 ClusterIP 服务。

Ø [**LoadBalancer**](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)**：**负载局衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。

以下需求全部是针对[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)类型的服务提出。

#### 4.8.2.1、新增

**SLB硬件设备新增**

在Zcloud启动时指定SLB硬件设备与连接信息。

**[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)服务新增**

[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)类型的服务被创建时，此事件应及时被监听处理。通过服务的配置信息（VIP，PORT，Endpoint，PATH等），由K8s内部插件主动向外部调用API，创建负载策略。每个VIP支持绑定多个不同端口的服务。

#### 4.8.2.2、删除

当[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)类型的服务被删除时，此事件应及时被监听处理。与此服务相关的所有负载策略一并清除。

#### 4.8.2.3、修改

当[LoadBalancer](https://v1-16.docs.kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer)类型的服务被修改时，此事件应及时被监听处理。端口变更，实例变化。

#### 4.8.2.4、查看

**SLB硬件设备**

从设备按业务能获取到以下指标：

HTTP的每秒请求包数，服务的网络吞吐量，服务的总连接数，请求命中率。

**负载策略**

按服务显示已经配置的负载策略。Vip，端口，endport，endip等等。

